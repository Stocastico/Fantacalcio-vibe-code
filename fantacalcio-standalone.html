<!doctype html>
<html lang="it">

<head>
    <meta charset="utf-8" />
    <title>Fantacalcio – Helper d'Asta (offuscato)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --primary: #6366f1;
            --primary-light: #a5b4fc;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --surface: #ffffff;
            --surface-2: #f8fafc;
            --surface-3: #f1f5f9;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            margin: 0;
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
        }

        h1 {
            margin-bottom: 8px;
            color: var(--primary-dark);
            font-weight: 700;
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .muted {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 400;
        }

        .pill {
            display: inline-block;
            padding: 8px 16px;
            margin: 4px;
            background: var(--surface);
            color: var(--text);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
        }

        .pill:nth-child(1) {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            color: #92400e;
        }

        .pill:nth-child(2) {
            background: linear-gradient(135deg, #dbeafe, #3b82f6);
            color: #1e40af;
        }

        .pill:nth-child(3) {
            background: linear-gradient(135deg, #dcfce7, #22c55e);
            color: #166534;
        }

        .pill:nth-child(4) {
            background: linear-gradient(135deg, #fce7f3, #ec4899);
            color: #be185d;
        }

        .pill:nth-child(5) {
            background: linear-gradient(135deg, #f3e8ff, #a855f7);
            color: #7c2d12;
        }

        .pill:nth-child(6) {
            background: linear-gradient(135deg, #e0f2fe, #06b6d4);
            color: #0e7490;
        }

        .pill:nth-child(7) {
            background: linear-gradient(135deg, #fff1f2, #f43f5e);
            color: #be123c;
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            background: var(--surface);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }

        .warn {
            color: var(--danger);
            font-weight: 600;
        }

        .ok {
            color: var(--secondary);
            font-weight: 600;
        }

        .out {
            margin-top: 16px;
            padding: 16px 20px;
            background: var(--surface-2);
            border-radius: 12px;
            min-height: 50px;
            white-space: pre-wrap;
            border: 1px solid var(--border);
            font-size: 14px;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.06);
        }

        label {
            font-size: 15px;
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
            color: var(--text);
        }

        input[type=text],
        input[type=password],
        input[type=number] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            font-size: 15px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        input[type=text]:focus,
        input[type=password]:focus,
        input[type=number]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--border);
        }

        button.secondary:hover {
            background: var(--surface-2);
            border-color: var(--primary-light);
        }

        button.emergency {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            border: none;
            font-weight: 700;
            box-shadow: 0 4px 14px 0 rgb(239 68 68 / 0.39);
        }

        button.emergency:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 6px 20px 0 rgb(239 68 68 / 0.5);
        }

        button.emergency:active {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .layout {
            display: grid;
            gap: 24px;
            grid-template-columns: 1fr;
        }

        @media (min-width:980px) {
            .layout {
                grid-template-columns: 1fr 360px;
                align-items: start;
            }

            .sidebar {
                position: sticky;
                top: 24px;
            }
        }

        ul.list {
            list-style: none;
            padding-left: 0;
            margin: 16px 0 0;
        }

        ul.list li {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 4px;
            background: var(--surface-2);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        ul.list li:hover {
            background: var(--surface-3);
            transform: translateX(4px);
        }

        ul.list li:last-child {
            border-bottom: none;
        }

        .flash-add {
            animation: flashAdd 1.8s ease-out;
        }

        @keyframes flashAdd {
            0% {
                background: linear-gradient(135deg, #fef3c7, #fbbf24);
                transform: scale(1.02);
            }

            30% {
                background: linear-gradient(135deg, #fef3c7, #fbbf24);
            }

            70% {
                background: var(--surface-2);
            }

            100% {
                background: var(--surface-2);
                transform: scale(1);
            }
        }

        h3 {
            color: var(--primary-dark);
            font-weight: 700;
            margin-top: 0;
        }

        h4 {
            color: var(--text);
            font-weight: 600;
        }

        details {
            margin-top: 12px;
        }

        summary {
            cursor: pointer;
            padding: 8px 12px;
            background: var(--surface-2);
            border-radius: 8px;
            font-weight: 600;
            color: var(--primary-dark);
            transition: all 0.2s ease;
        }

        summary:hover {
            background: var(--surface-3);
            color: var(--primary);
        }

        /* Special styling for auction section */
        #auctionSection {
            background: linear-gradient(135deg, #eff6ff, #dbeafe) !important;
            border: 2px solid var(--primary-light) !important;
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1) !important;
        }
    </style>
</head>

<body>
    <h1>Fantacalcio – Helper d'Asta</h1>
    <p class="muted">
        Lista <strong>offuscata</strong> con passphrase. Non è cifratura forte, ma scoraggia chi apre il sorgente.
    </p>

    <!-- BLOCCO SBLOCCO -->
    <div id="locked" class="card" style="max-width:580px;">
        <h3>Sblocca la lista</h3>
        <label for="pw">Passphrase</label>
        <input id="pw" type="password" placeholder="Inserisci passphrase" />
        <div class="row">
            <button id="btnUnlock">Sblocca</button>
        </div>
        <div id="outUnlock" class="out"></div>
        <p class="muted">Dopo lo sblocco, la pagina funziona offline come l'helper normale.</p>
    </div>

    <!-- APP -->
    <div id="app" style="display:none;">
        <div class="row">
            <span class="pill" id="countP">P: 0</span>
            <span class="pill" id="countD">D: 0</span>
            <span class="pill" id="countC">C: 0</span>
            <span class="pill" id="countA">A: 0</span>
            <span class="pill" id="sumNow">Somma tetti: 0</span>
            <span class="pill" id="budgetLeft">Crediti residui: 500</span>
            <span class="pill" id="playersLeft">Giocatori rimanenti: 0</span>
        </div>

        <div class="layout" style="margin-top:16px;">
            <!-- SINISTRA: strumenti base -->
            <div>
                <div class="grid">
                    <!-- 1) CERCA -->
                    <section class="card">
                        <h3>1) Fai offerta per un giocatore</h3>

                        <!-- Random player selection -->
                        <div style="margin-bottom:16px;">
                            <p class="muted">Estrai un giocatore a caso dalla tua lista e inizia l'asta con offerta di 1
                                credito:</p>
                            <div class="row">
                                <button id="btnRandom">Estrai e inizia asta</button>
                                <button id="btnShowLeft" class="emergency">⚠️ Mostra lista rimanente</button>
                                <button id="btnReset" class="secondary"
                                    title="Ripristina lista originale">Reset</button>
                            </div>
                            <div id="outRandom" class="out"></div>
                            <details id="leftWrap" style="display:none; margin-top:8px;">
                                <summary>Lista rimanente</summary>
                                <div id="leftList" class="muted"></div>
                            </details>
                        </div>

                        <!-- Separator -->
                        <div style="text-align:center; margin:20px 0; font-size:1.2em; font-weight:bold; color:#666;">
                            Oppure
                        </div>

                        <!-- Manual search -->
                        <div>
                            <label for="q">Nome giocatore</label>
                            <input id="q" type="text" placeholder="es. Lautaro, Dybala, Zaccagni..." />
                            <div class="row">
                                <button id="btnCheck">Cerca nella mia lista</button>
                                <button id="btnClear" class="secondary">Pulisci</button>
                            </div>
                            <div id="outCheck" class="out"></div>
                        </div>

                        <!-- Auction bidding section (hidden initially) -->
                        <div id="auctionSection"
                            style="display:none; margin-top:12px; padding:12px; background:#f0f8ff; border-radius:8px;">
                            <h4 style="margin-top:0;">🏷️ Asta in corso</h4>
                            <div id="playerInfo" style="margin-bottom:8px; font-weight:bold;"></div>
                            <label for="currentOffer">Offerta attuale in asta</label>
                            <input id="currentOffer" type="number" inputmode="numeric" min="1" step="1"
                                placeholder="es. 25" />
                            <div class="row" style="margin-top:8px;">
                                <button id="btnCalculateBid">Calcola mia offerta</button>
                                <button id="btnPlayerWon" class="secondary">Giocatore acquisito</button>
                                <button id="btnPlayerLost" class="secondary">Giocatore andato</button>
                            </div>
                            <div id="outAuction" class="out"></div>
                        </div>

                        <p class="muted">Se il nome è ambiguo oppure parziale, ti suggerisco i match possibili.</p>
                    </section>
                </div>
            </div>

            <!-- DESTRA: sidebar acquisti -->
            <aside class="sidebar">
                <section class="card">
                    <h3>Rosa acquistata</h3>
                    <p class="muted">Giocatori acquisiti tramite asta. Usa la sezione "Cerca giocatore e asta" per
                        aggiungere
                        nuovi acquisti.</p>

                    <ul id="purchasesList" class="list"></ul>

                    <div class="row" style="margin-top:12px;">
                        <span class="pill" id="spentPill">Speso: 0</span>
                        <span class="pill" id="leftPill">Residuo: 500</span>
                    </div>

                    <div class="row" style="margin-top:8px;">
                        <button id="btnUndoBuy" class="secondary">Annulla ultimo</button>
                        <button id="btnExportCSV" class="secondary">Esporta CSV</button>
                    </div>

                    <div id="outBuy" class="out"></div>
                </section>
            </aside>
        </div>

        <details class="card" style="margin-top:16px;">
            <summary>Avanzato: re-offusca con nuova passphrase</summary>
            <p class="muted">
                Dopo lo sblocco, puoi inserire una nuova passphrase e ottenere una stringa offuscata da sostituire nel
                file
                (variabile <code>OBF</code>).
                Questo non salva automaticamente: copia/incolla manualmente.
            </p>
            <label for="newpw">Nuova passphrase</label>
            <input id="newpw" type="password" placeholder="Nuova passphrase" />
            <div class="row">
                <button id="btnReObf">Genera nuova stringa offuscata</button>
            </div>
            <div id="outReObf" class="out"></div>
        </details>
    </div>

    <script>
        // === DATA OBFUSCATA ===
        const OBF = "BueD+8FfsC3ZOorcIq9LSmWQDRmNoq2d16LwFFPBCl8U0IPHmG93hsGGpegbbhb+VONTWI+cY2TX2j0wlrciH/uOja/CW68t2U/BpzFuSj1t0wMxPYampSXNQOZdt1psF9GDx4JCbTfBeq3f2IYRWSzpA2V8oKZa74ooJaEFSWAa39Xugh5tfQ6EqZ3wbiD+LJBDYH9Ve2nn5fo/UwNJahCOm6+wYb5uBzpwnSi7SEEiqAM7PV9jmh7M8P5ixWUpJo7P7s1XbUXBaKXtH79F/iyQU2aHmGNy16zw8FP3UWHNppoKjG1teQCFqZ3wbiBLadUDIz2lsKQaigjmdbcUHw3Vxa+aKsg3Gjqy3COx/hYitUJrj5xjZNfaPTCWtyIf746Nr8Jbry3ZUMGnMW5KPW3TAzE9hqaqI9ExM532CinN3tD5xRSFLeM6cJ0YtUD+OqNeI5ZVr5kizfD+U+tJaRDeyq+MFL16C31mtdiQ/ggi0EpbPW11teHj8DKSAk0f5Y677tBirC3LOrbqIrH+FiKyAyM9laqc16ICQV0QCmsM2cavmhSYbvOHseQkrVX+LJBTZoeYY3LXq/DwU/dRYc2mlsLdHsYtDXmx4NiG/iJyz1VrgKaqWuGKQDOd+go3za+DuYJUtG/BUnW0M3hX/m7PTlw9bWN6FtQyJZ8PUR/XjtP8zFdtRcFbZqfYrkVAIqgSL5hfvFojyTspU88KTQzfwvnJVW03wYqz5xtuFv5DkA0ZfZylWu+ZBkFdEAprDNnGr5oUmHYHgbjcKMU9SiKaA2mKn6Za74oR5l23SmYPjpu+km93hsGGpegbbhb+QuBGan6coqYe1jfmXbdabBfRg8eCNW03wXqt39iGFFks6QNlfKCmWu+KFzCa+Aopzd7Q+cUUhS3iOnCdGLVA/jqjXiOWVa+ZIs3w/lPbTW8S4dT8zhR3LRGHsODYhv4fIpoDWYSXY3Lq5fo/UwNJahCOm6+sU8B/AIqzmwOtTlDDG09clVVtWifXOilTzwo+zZiD78lWbUXYSMGnMW5KPW3TAzE9d7qaFtQv5l23WmwX0YPHgjNtN8F6rd/YhhEMfZpcGYmUrp3XovAWkghYXg/b0/aCHm19DoSpnfBuHf4skENgf1V7bO3l+j9TA0lqEI6br7pTrm4Af7Lk2Hj+Tm/aRhlVVYJa4YowLZW3IjHh6Y0IgmCseAQ6fp0KrU5BbdcDIz2lsKQaigjmcrcUHw3Vxa+aJIGIy5Nm6Re5Qf46kC1skaiumiSK+uajBFRizaaDzoIebW0IfGa16HxZOQ==";

        // Utils
        async function sha256Bytes(str) { const enc = new TextEncoder().encode(str); const hash = await crypto.subtle.digest("SHA-256", enc); return new Uint8Array(hash); }
        function b64ToBytes(b64) { const bin = atob(b64); const out = new Uint8Array(bin.length); for (let i = 0; i < bin.length; i++)out[i] = bin.charCodeAt(i); return out; }
        function bytesToB64(bytes) { let bin = ""; for (let i = 0; i < bytes.length; i++)bin += String.fromCharCode(bytes[i]); return btoa(bin); }
        function deobfuscate(obf, key) { const out = new Uint8Array(obf.length); for (let i = 0; i < obf.length; i++)out[i] = (obf[i] - key[i % key.length] + 256) % 256; return out; }
        function obfuscate(plain, key) { const out = new Uint8Array(plain.length); for (let i = 0; i < plain.length; i++)out[i] = (plain[i] + key[i % key.length]) % 256; return out; }

        // State
        let ORIGINAL = null, roster = null; const START_BUDGET = 500; let purchases = []; let spent = 0; let currentAuctionPlayer = null; let lastSuggestedBid = null;
        const norm = s => (s || "").normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase().replace(/\s+/g, " ").trim();
        const sumBid = list => list.reduce((a, x) => a + (x.bid || 0), 0);
        const countsByRole = list => list.reduce((m, x) => (m[x.role] = (m[x.role] || 0) + 1, m), { P: 0, D: 0, C: 0, A: 0 });

        function updateCounters() {
            if (!roster) return;
            const c = countsByRole(roster);
            document.getElementById("countP").textContent = `P: ${c.P}`;
            document.getElementById("countD").textContent = `D: ${c.D}`;
            document.getElementById("countC").textContent = `C: ${c.C}`;
            document.getElementById("countA").textContent = `A: ${c.A}`;
            document.getElementById("sumNow").textContent = `Somma tetti: ${sumBid(roster)}`;
            document.getElementById("budgetLeft").textContent = `Crediti residui: ${START_BUDGET - spent}`;
            document.getElementById("playersLeft").textContent = `Giocatori rimanenti: ${roster.length}`;
            document.getElementById("spentPill").textContent = `Speso: ${spent}`;
            document.getElementById("leftPill").textContent = `Residuo: ${START_BUDGET - spent}`;
        }

        // Variante 'ext': non mostra il tetto massimo/prezzo stimato
        const formatPlayer = p => `${p.name} - ${p.role}`;

        function listRemaining() {
            const order = { P: 0, D: 1, C: 2, A: 3 };
            return [...roster].sort((a, b) => (order[a.role] - order[b.role]) || (b.bid - a.bid) || a.name.localeCompare(b.name)).map(formatPlayer).join("\n");
        }

        function findCandidates(q, inList = roster) {
            const s = norm(q);
            if (!s) return [];
            const exact = inList.filter(p => norm(p.name) === s);
            if (exact.length === 1) return exact;
            return inList.filter(p => norm(p.name).includes(s));
        }

        function redistributeCredits(savedCredits, purchasedPlayerName) {
            if (savedCredits <= 0 || !roster || roster.length === 0) return 0;

            // Get remaining players (excluding the one just purchased) sorted by max bid (highest first)
            const remainingPlayers = roster
                .filter(p => norm(p.name) !== norm(purchasedPlayerName))
                .sort((a, b) => (b.bid || 0) - (a.bid || 0));

            let creditsToDistribute = Math.min(savedCredits, remainingPlayers.length);
            let distributed = 0;

            // Add +1 to the most expensive players until credits run out
            for (let i = 0; i < creditsToDistribute && i < remainingPlayers.length; i++) {
                remainingPlayers[i].bid = (remainingPlayers[i].bid || 0) + 1;
                distributed++;
            }

            return distributed;
        }

        function addPurchase(name, price) {
            const out = document.getElementById("outBuy");
            if (!name) { out.innerHTML = "❌ Nome mancante."; return false; }
            if (!Number.isFinite(price) || price < 0) { out.innerHTML = "❌ Prezzo non valido."; return false; }
            const priceInt = Math.round(price);
            const playerInList = ORIGINAL ? ORIGINAL.find(p => norm(p.name) === norm(name)) : null;
            if (!playerInList) { out.innerHTML = `❌ <span class="warn">"${name}" non è nella tua lista originale di giocatori.</span>`; return false; }
            const already = purchases.find(p => norm(p.name) === norm(name));
            if (already) { out.innerHTML = `❌ <span class="warn">"${name}" già acquistato (${already.price} crediti).`; return false; }
            if (spent + priceInt > START_BUDGET) { out.innerHTML = `❌ <span class="warn">Budget insufficiente. Residuo ${START_BUDGET - spent}, prezzo ${priceInt}.`; return false; }

            const over = playerInList.bid && priceInt > playerInList.bid;
            const savedCredits = playerInList.bid ? Math.max(0, playerInList.bid - priceInt) : 0;

            purchases.push({ name, price: priceInt });
            spent += priceInt;

            // Redistribute saved credits to remaining players
            let redistributed = 0;
            if (savedCredits > 0) {
                redistributed = redistributeCredits(savedCredits, name);
            }

            const li = document.createElement("li");
            li.textContent = `${name} - ${priceInt}` + (over ? ` (>${playerInList.bid})` : "");
            li.classList.add("flash-add");
            document.getElementById("purchasesList").appendChild(li);

            let message = over ? `⚠️ Aggiunto "${name}" per ${priceInt}` : `✅ Aggiunto "${name}" per ${priceInt}`;
            if (redistributed > 0) {
                message += ` | 💰 ${redistributed} crediti ridistribuiti ai giocatori più costosi`;
            }
            out.innerHTML = message;

            updateCounters();
            return li;
        }

        function undoPurchase() {
            const out = document.getElementById("outBuy");
            if (purchases.length === 0) { out.innerHTML = "⚠️ Nessun acquisto da annullare."; return; }
            const last = purchases.pop();
            spent -= last.price;
            const list = document.getElementById("purchasesList");
            if (list.lastChild) list.removeChild(list.lastChild);
            out.innerHTML = `↩️ Annullato "${last.name}" per ${last.price}`;
            updateCounters();
        }

        function exportCSV() {
            const out = document.getElementById("outBuy");
            if (purchases.length === 0) { out.innerHTML = "⚠️ Nessun acquisto da esportare."; return; }
            const rows = [["Nome", "Prezzo"], ...purchases.map(p => [p.name, String(p.price)])];
            rows.push(["Totale speso", String(spent)]);
            rows.push(["Residuo", String(START_BUDGET - spent)]);
            const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g, '""')}"`).join(",")).join("\n");
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `acquisti_fantacalcio_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            out.innerHTML = "📦 CSV esportato.";
        }

        const $ = sel => document.querySelector(sel);

        // Unlock logic function
        async function performUnlock() {
            const pw = $("#pw").value || "";
            const out = $("#outUnlock");
            try {
                const key = await sha256Bytes(pw);
                const obf = b64ToBytes(OBF);
                const plain = deobfuscate(obf, key);
                const text = new TextDecoder().decode(plain);
                const parsed = JSON.parse(text);
                if (!Array.isArray(parsed) || parsed.length === 0) throw new Error("Formato elenco non valido.");
                ORIGINAL = parsed;
                roster = JSON.parse(JSON.stringify(ORIGINAL));
                $("#locked").style.display = "none";
                $("#app").style.display = "";
                updateCounters();
                document.getElementById("leftList").textContent = listRemaining();
            } catch (e) {
                console.error(e);
                out.innerHTML = "❌ <span class='warn'>Passphrase errata o dati corrotti.</span>";
            }
        }

        // Unlock button click
        $("#btnUnlock").addEventListener("click", performUnlock);

        // Unlock on Enter key press in password field
        $("#pw").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                performUnlock();
            }
        });

        // Main event delegation
        document.addEventListener("click", ev => {
            const id = ev.target && ev.target.id;
            if (!id) return;

            if (id === "btnCheck") {
                const q = $("#q").value;
                const out = $("#outCheck");
                const auctionSection = document.getElementById("auctionSection");
                const matches = findCandidates(q);
                if (matches.length === 0) {
                    out.innerHTML = `❌ <span class="warn">"${q}" non è nella tua lista attuale.</span>`;
                    auctionSection.style.display = "none";
                    currentAuctionPlayer = null;
                    lastSuggestedBid = null;
                } else if (matches.length > 1) {
                    out.textContent = `⚠️ Trovati più match:\n- ${matches.map(m => m.name).join("\n- ")}`;
                    auctionSection.style.display = "none";
                    currentAuctionPlayer = null;
                    lastSuggestedBid = null;
                } else {
                    const player = matches[0];
                    currentAuctionPlayer = player;
                    lastSuggestedBid = null;
                    out.innerHTML = `✅ <span class="ok">${formatPlayer(player)}</span>`;
                    document.getElementById("playerInfo").innerHTML = `<strong>${player.name}</strong> (${player.role})`;
                    document.getElementById("currentOffer").value = "";
                    document.getElementById("outAuction").innerHTML = "";
                    auctionSection.style.display = "block";
                }
            }

            if (id === "btnClear") {
                $("#q").value = "";
                $("#outCheck").textContent = "";
                document.getElementById("auctionSection").style.display = "none";
                currentAuctionPlayer = null;
                lastSuggestedBid = null;
                $("#q").focus();
            }

            if (id === "btnRandom") {
                const out = $("#outRandom");
                if (!roster || roster.length === 0) {
                    out.innerHTML = "❌ Lista vuota: nessun giocatore rimanente.";
                    return;
                }
                const i = Math.floor(Math.random() * roster.length);
                const p = roster[i];
                out.innerHTML = `🎯 <strong>${p.name}</strong> - ruolo ${p.role}`;
                currentAuctionPlayer = p;
                lastSuggestedBid = null;
                const auctionSection = document.getElementById("auctionSection");
                document.getElementById("playerInfo").innerHTML = `<strong>${p.name}</strong> (${p.role})`;
                document.getElementById("currentOffer").value = "1";
                document.getElementById("outAuction").innerHTML = "";
                auctionSection.style.display = "block";
                auctionSection.scrollIntoView({ behavior: "smooth" });
            }

            if (id === "btnShowLeft") {
                const wrap = document.getElementById("leftWrap");
                const list = document.getElementById("leftList");
                if (wrap.style.display === "none") {
                    list.textContent = listRemaining();
                    wrap.style.display = "";
                } else wrap.style.display = "none";
            }

            if (id === "btnReset") {
                if (!confirm("Ripristinare la lista originale (500 totali)?")) return;
                roster = JSON.parse(JSON.stringify(ORIGINAL));
                updateCounters();
                document.getElementById("leftList").textContent = listRemaining();
                document.getElementById("outRandom").textContent = "";
                document.getElementById("outCheck").textContent = "";
            }

            if (id === "btnReObf") {
                const newpw = $("#newpw").value || "";
                const out = $("#outReObf");
                if (!newpw) {
                    out.innerHTML = "❌ Inserisci una nuova passphrase.";
                    return;
                }
                (async () => {
                    try {
                        const key = await sha256Bytes(newpw);
                        const text = JSON.stringify(ORIGINAL);
                        const plain = new TextEncoder().encode(text);
                        const obf = obfuscate(plain, key);
                        const b64 = bytesToB64(obf);
                        out.innerHTML = "✅ Nuova stringa OBF (copiala nel file sulla variabile <code>OBF</code>):\n\n" + b64;
                    } catch (e) {
                        console.error(e);
                        out.innerHTML = "❌ Errore nella generazione.";
                    }
                })();
            }

            if (id === "btnUndoBuy") undoPurchase();

            if (id === "btnExportCSV") exportCSV();

            if (id === "btnCalculateBid") {
                if (!currentAuctionPlayer) return;
                const outAuction = document.getElementById("outAuction");
                const val = document.getElementById("currentOffer").value || "";
                if (!val) {
                    outAuction.innerHTML = "❌ Inserisci l'offerta attuale.";
                    return;
                }
                const currentOffer = Number(val);
                if (!Number.isFinite(currentOffer) || currentOffer < 1) {
                    outAuction.innerHTML = "❌ Offerta non valida.";
                    return;
                }
                const currentOfferInt = Math.round(currentOffer);
                const maxBid = currentAuctionPlayer.bid;
                if (currentOfferInt >= maxBid) {
                    // lost - remove from roster
                    const before = roster.length;
                    roster = roster.filter(p => p.name !== currentAuctionPlayer.name);
                    if (roster.length !== before) {
                        updateCounters();
                        if (document.getElementById("leftWrap").style.display !== "none")
                            document.getElementById("leftList").textContent = listRemaining();
                    }
                    outAuction.innerHTML = `😞 <strong>${currentAuctionPlayer.name}</strong> andato ad altri (raggiunto limite interno).`;
                    lastSuggestedBid = null;
                    setTimeout(() => {
                        document.getElementById("auctionSection").style.display = "none";
                        currentAuctionPlayer = null;
                    }, 2500);
                } else {
                    // Easter egg: if max bid > 37 and current offer < 35, offer 36
                    let ourBid;
                    if (maxBid > 37 && currentOfferInt < 35) {
                        ourBid = 36;
                    } else {
                        ourBid = currentOfferInt + 1;
                    }
                    lastSuggestedBid = { player: currentAuctionPlayer.name, value: ourBid };
                    outAuction.innerHTML = `💰 <span class="ok">Offriamo: <strong>${ourBid}</strong> crediti</span>`;
                }
            }

            if (id === "btnPlayerWon") {
                if (!currentAuctionPlayer) return;
                const val = document.getElementById("currentOffer").value || "";
                const outAuction = document.getElementById("outAuction");
                if (!val) {
                    outAuction.innerHTML = "❌ Inserisci il prezzo finale di acquisto.";
                    return;
                }
                const base = Math.round(Number(val));
                if (!Number.isFinite(base) || base < 0) {
                    outAuction.innerHTML = "❌ Prezzo non valido.";
                    return;
                }
                // Usa il suggerimento calcolato (ourBid) se ancora valido, altrimenti assume base+1
                let finalPrice = base + 1;
                if (lastSuggestedBid && lastSuggestedBid.player === currentAuctionPlayer.name)
                    finalPrice = lastSuggestedBid.value;
                const li = addPurchase(currentAuctionPlayer.name, finalPrice);
                if (li) {
                    const before = roster.length;
                    roster = roster.filter(p => norm(p.name) !== norm(currentAuctionPlayer.name));
                    if (roster.length !== before) {
                        updateCounters();
                        if (document.getElementById("leftWrap").style.display !== "none")
                            document.getElementById("leftList").textContent = listRemaining();
                    }
                    outAuction.innerHTML = `🎉 <strong>${currentAuctionPlayer.name}</strong> acquisito, budget aggiornato e rimosso dalla lista rimanente.`;
                    li.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => li.classList.remove('flash-add'), 1600);
                    document.getElementById("auctionSection").style.display = "none";
                    currentAuctionPlayer = null;
                    lastSuggestedBid = null;
                } else {
                    outAuction.innerHTML = `⚠️ Verifica messaggi sotto la sezione acquisti: impossibile aggiungere <strong>${currentAuctionPlayer.name}</strong>.`;
                }
            }

            if (id === "btnPlayerLost") {
                if (!currentAuctionPlayer) return;
                const outAuction = document.getElementById("outAuction");
                const before = roster.length;
                roster = roster.filter(p => p.name !== currentAuctionPlayer.name);
                if (roster.length !== before) {
                    updateCounters();
                    if (document.getElementById("leftWrap").style.display !== "none")
                        document.getElementById("leftList").textContent = listRemaining();
                    outAuction.innerHTML = `😞 <strong>${currentAuctionPlayer.name}</strong> andato ad altri e rimosso.`;
                } else {
                    outAuction.innerHTML = `😞 <strong>${currentAuctionPlayer.name}</strong> andato ad altri.`;
                }
                setTimeout(() => {
                    document.getElementById("auctionSection").style.display = "none";
                    currentAuctionPlayer = null;
                }, 1800);
            }
        });

        // Uncomment the line below to enable testing functions
        // document.write('<script src="test-suite.js"><\/script>');
    </script>

</body>

</html>